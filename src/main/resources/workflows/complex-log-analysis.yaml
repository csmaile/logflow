# yaml-language-server: $schema=../schemas/logflow-workflow-schema.json
# 复杂日志分析工作流配置
workflow:
  id: "complex_log_analysis_yaml"
  name: "复杂日志分析（YAML配置）"
  description: "包含数据预处理、多重诊断和结果聚合的复杂工作流"
  version: "2.0.0"
  author: "LogFlow Advanced Team"
  metadata:
    category: "高级日志分析"
    tags: ["数据预处理", "多重诊断", "脚本处理"]
    complexity: "high"

# 全局配置
globalConfig:
  timeout: 60000
  retryCount: 5
  logLevel: "DEBUG"
  enableMetrics: true

# 节点定义
nodes:
  # 配置输入节点
  - id: "config_input"
    name: "分析配置输入"
    type: "input"
    position:
      x: 50
      y: 50
    config:
      inputs:
        - key: "analysis_config"
          alias: "analysisConfig"
          required: true
          dataType: "object"
          description: "分析配置参数"
      outputKey: "config"

  # 日志数据源
  - id: "log_data_source"
    name: "日志文件数据源"
    type: "plugin"
    position:
      x: 50
      y: 150
    config:
      pluginType: "mock"
      mockType: "ARRAY"
      recordCount: 500
      dataFormat: "JSON"
      outputKey: "raw_logs"

  # 数据预处理脚本
  - id: "data_preprocessor"
    name: "数据预处理器"
    type: "script"
    position:
      x: 250
      y: 150
    config:
      scriptEngine: "javascript"
      inputs:
        - key: "raw_logs"
          alias: "logs"
          required: true
          dataType: "array"
          description: "原始日志数据"
        - key: "config"
          alias: "config"
          required: false
          defaultValue:
            minLevel: "INFO"
          dataType: "object"
          description: "处理配置"
      outputKey: "filtered_logs"
      script: |
        var config = typeof config !== 'undefined' ? config : {};
        var logs = typeof logs !== 'undefined' ? logs : [];
        var filtered = [];
        var errorCount = 0;
        
        for (var i = 0; i < logs.length; i++) {
          var log = logs[i];
          
          // 根据配置过滤日志级别
          if (config && config.minLevel) {
            var levels = ['DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL'];
            var minIndex = levels.indexOf(config.minLevel);
            var logIndex = levels.indexOf(log.level);
            if (logIndex < minIndex) {
              continue;
            }
          }
          
          // 统计错误数量
          if (log.level === 'ERROR' || log.level === 'FATAL') {
            errorCount++;
          }
          
          // 添加时间戳解析
          log.parsedTime = new Date(log.timestamp);
          log.hour = log.parsedTime.getHours();
          
          filtered.push(log);
        }
        
        // 设置统计信息到上下文
        context.set('preprocessing_stats', {
          totalInput: logs.length,
          totalOutput: filtered.length,
          errorCount: errorCount,
          filterRate: ((logs.length - filtered.length) / logs.length * 100).toFixed(2)
        });
        
        logger.info('数据预处理完成: 输入' + logs.length + '条，输出' + filtered.length + '条，错误' + errorCount + '条');
        filtered;

  # 错误检测
  - id: "error_diagnosis"
    name: "错误诊断"
    type: "diagnosis"
    position:
      x: 450
      y: 100
    config:
      diagnosisType: "error_detection"
      inputs:
        - key: "filtered_logs"
          alias: "logData"
          required: true
          dataType: "array"
          description: "过滤后的日志数据"
      outputKey: "error_results"
      errorPatterns: ["ERROR", "FATAL", "Exception", "Timeout", "Failed"]

  # 性能分析
  - id: "performance_diagnosis"
    name: "性能诊断"
    type: "diagnosis"
    position:
      x: 450
      y: 200
    config:
      diagnosisType: "performance_analysis"
      inputs:
        - key: "filtered_logs"
          alias: "logData"
          required: true
          dataType: "array"
          description: "过滤后的日志数据"
      outputKey: "performance_results"
      slowThreshold: 1000.0

  # 模式分析
  - id: "pattern_diagnosis"
    name: "模式分析"
    type: "diagnosis"
    position:
      x: 450
      y: 300
    config:
      diagnosisType: "pattern_analysis"
      inputs:
        - key: "filtered_logs"
          alias: "logData"
          required: true
          dataType: "array"
          description: "过滤后的日志数据"
      outputKey: "pattern_results"

  # 异常检测
  - id: "anomaly_diagnosis"
    name: "异常检测"
    type: "diagnosis"
    position:
      x: 450
      y: 400
    config:
      diagnosisType: "anomaly_detection"
      inputs:
        - key: "filtered_logs"
          alias: "logData"
          required: true
          dataType: "array"
          description: "过滤后的日志数据"
      outputKey: "anomaly_results"

  # 结果聚合脚本
  - id: "result_aggregator"
    name: "结果聚合器"
    type: "script"
    position:
      x: 650
      y: 250
    config:
      scriptEngine: "javascript"
      inputs:
        - key: "error_results"
          alias: "errorResults"
          required: true
          dataType: "object"
          description: "错误诊断结果"
        - key: "performance_results"
          alias: "performanceResults"
          required: true
          dataType: "object"
          description: "性能诊断结果"
        - key: "pattern_results"
          alias: "patternResults"
          required: true
          dataType: "object"
          description: "模式分析结果"
        - key: "anomaly_results"
          alias: "anomalyResults"
          required: true
          dataType: "object"
          description: "异常检测结果"
        - key: "preprocessing_stats"
          alias: "preprocessingStats"
          required: false
          defaultValue: {}
          dataType: "object"
          description: "预处理统计"
      mergeKey: "allResults"
      outputKey: "final_report"
      script: |
        var allResults = typeof allResults !== 'undefined' ? allResults : {};
        var errorResults = allResults.errorResults || {};
        var performanceResults = allResults.performanceResults || {};
        var patternResults = allResults.patternResults || {};
        var anomalyResults = allResults.anomalyResults || {};
        var preprocessingStats = allResults.preprocessingStats || {};
        
        // 计算总体风险评分
        var riskScore = 0;
        if (errorResults.issueCount > 10) riskScore += 30;
        else if (errorResults.issueCount > 5) riskScore += 20;
        else if (errorResults.issueCount > 0) riskScore += 10;
        
        if (performanceResults.issueCount > 5) riskScore += 25;
        else if (performanceResults.issueCount > 0) riskScore += 10;
        
        if (anomalyResults.issueCount > 3) riskScore += 20;
        else if (anomalyResults.issueCount > 0) riskScore += 10;
        
        // 确定风险级别
        var riskLevel = 'LOW';
        if (riskScore >= 50) riskLevel = 'CRITICAL';
        else if (riskScore >= 30) riskLevel = 'HIGH';
        else if (riskScore >= 15) riskLevel = 'MEDIUM';
        
        var report = {
          timestamp: utils.now(),
          summary: {
            riskScore: riskScore,
            riskLevel: riskLevel,
            totalIssues: errorResults.issueCount + performanceResults.issueCount + 
                        patternResults.issueCount + anomalyResults.issueCount,
            preprocessing: preprocessingStats
          },
          diagnostics: {
            errors: {
              count: errorResults.issueCount,
              severity: errorResults.maxSeverity,
              issues: errorResults.issues
            },
            performance: {
              count: performanceResults.issueCount,
              severity: performanceResults.maxSeverity,
              issues: performanceResults.issues
            },
            patterns: {
              count: patternResults.issueCount,
              findings: patternResults.issues
            },
            anomalies: {
              count: anomalyResults.issueCount,
              findings: anomalyResults.issues
            }
          },
          recommendations: []
        };
        
        // 生成建议
        if (errorResults.issueCount > 10) {
          report.recommendations.push('系统错误率较高，建议立即检查日志并修复相关问题');
        }
        if (performanceResults.issueCount > 5) {
          report.recommendations.push('发现多个性能问题，建议优化响应时间');
        }
        if (anomalyResults.issueCount > 0) {
          report.recommendations.push('检测到异常模式，建议进一步调查');
        }
        if (report.recommendations.length === 0) {
          report.recommendations.push('系统运行正常，继续监控');
        }
        
        logger.info('生成综合分析报告: 风险等级=' + riskLevel + ', 总问题数=' + report.summary.totalIssues);
        report;

  # JSON报告输出
  - id: "json_report_output"
    name: "JSON报告输出"
    type: "notification"
    position:
      x: 850
      y: 200
    config:
      providerType: "file"
      inputs:
        - key: "final_report"
          alias: "report"
          required: true
          dataType: "object"
          description: "最终分析报告"
      title: "复杂日志分析报告"
      messageType: "JSON"
      priority: "NORMAL"
      provider:
        filePath: "complex_analysis_report.json"
        format: "json"

  # 控制台摘要输出
  - id: "console_summary"
    name: "控制台摘要"
    type: "notification"
    position:
      x: 850
      y: 300
    config:
      providerType: "console"
      inputs:
        - key: "final_report"
          alias: "report"
          required: true
          dataType: "object"
          description: "最终分析报告"
      title: "复杂日志分析摘要"
      messageType: "TEXT"
      priority: "HIGH"
      provider:
        format: "detailed"
        timestamp: true

# 连接关系
connections:
  # 配置输入到数据源
  - from: "config_input"
    to: "log_data_source"
    enabled: true

  # 数据源到预处理
  - from: "log_data_source"
    to: "data_preprocessor"
    enabled: true

  # 预处理到各个诊断节点
  - from: "data_preprocessor"
    to: "error_diagnosis"
    enabled: true

  - from: "data_preprocessor"
    to: "performance_diagnosis"
    enabled: true

  - from: "data_preprocessor"
    to: "pattern_diagnosis"
    enabled: true

  - from: "data_preprocessor"
    to: "anomaly_diagnosis"
    enabled: true

  # 所有诊断结果到聚合器
  - from: "error_diagnosis"
    to: "result_aggregator"
    enabled: true

  - from: "performance_diagnosis"
    to: "result_aggregator"
    enabled: true

  - from: "pattern_diagnosis"
    to: "result_aggregator"
    enabled: true

  - from: "anomaly_diagnosis"
    to: "result_aggregator"
    enabled: true

  # 聚合结果到输出
  - from: "result_aggregator"
    to: "json_report_output"
    enabled: true

  - from: "result_aggregator"
    to: "console_summary"
    enabled: true
