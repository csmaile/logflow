{
    "$schema": "https://json-schema.org/draft-07/schema#",
    "$id": "https://logflow.com/schemas/workflow.schema.json",
    "title": "LogFlow Workflow Configuration",
    "description": "LogFlow日志诊断工作流配置文件Schema",
    "type": "object",
    "required": [
        "workflow",
        "nodes"
    ],
    "properties": {
        "workflow": {
            "type": "object",
            "title": "工作流基本信息",
            "description": "定义工作流的基本信息和元数据",
            "required": [
                "id",
                "name"
            ],
            "properties": {
                "id": {
                    "type": "string",
                    "title": "工作流ID",
                    "description": "工作流的唯一标识符",
                    "pattern": "^[a-zA-Z][a-zA-Z0-9_-]*$",
                    "examples": [
                        "log_analysis",
                        "error_detection",
                        "performance_monitoring"
                    ]
                },
                "name": {
                    "type": "string",
                    "title": "工作流名称",
                    "description": "工作流的显示名称",
                    "minLength": 1,
                    "examples": [
                        "日志分析工作流",
                        "错误检测",
                        "性能监控"
                    ]
                },
                "description": {
                    "type": "string",
                    "title": "工作流描述",
                    "description": "详细描述工作流的功能和用途",
                    "examples": [
                        "分析应用程序日志并检测错误模式",
                        "实时监控系统性能指标"
                    ]
                },
                "version": {
                    "type": "string",
                    "title": "版本号",
                    "description": "工作流的版本，建议使用语义化版本",
                    "pattern": "^\\d+\\.\\d+\\.\\d+.*$",
                    "examples": [
                        "1.0.0",
                        "2.1.0-beta",
                        "1.2.3"
                    ]
                },
                "author": {
                    "type": "string",
                    "title": "作者",
                    "description": "工作流的创建者",
                    "examples": [
                        "LogFlow Team",
                        "张三",
                        "开发团队"
                    ]
                },
                "metadata": {
                    "type": "object",
                    "title": "元数据",
                    "description": "额外的元数据信息",
                    "properties": {
                        "category": {
                            "type": "string",
                            "description": "工作流分类",
                            "examples": [
                                "日志分析",
                                "性能监控",
                                "错误检测"
                            ]
                        },
                        "tags": {
                            "type": "array",
                            "description": "标签列表",
                            "items": {
                                "type": "string"
                            },
                            "examples": [
                                [
                                    "日志",
                                    "错误",
                                    "实时"
                                ],
                                [
                                    "性能",
                                    "监控",
                                    "告警"
                                ]
                            ]
                        },
                        "complexity": {
                            "type": "string",
                            "description": "复杂度级别",
                            "enum": [
                                "low",
                                "medium",
                                "high"
                            ],
                            "examples": [
                                "low",
                                "medium",
                                "high"
                            ]
                        }
                    },
                    "additionalProperties": true
                }
            },
            "additionalProperties": false
        },
        "globalConfig": {
            "type": "object",
            "title": "全局配置",
            "description": "应用于整个工作流的全局配置选项",
            "properties": {
                "timeout": {
                    "type": "integer",
                    "title": "超时时间",
                    "description": "工作流执行超时时间（毫秒）",
                    "minimum": 1000,
                    "maximum": 3600000,
                    "default": 30000,
                    "examples": [
                        30000,
                        60000,
                        120000
                    ]
                },
                "retryCount": {
                    "type": "integer",
                    "title": "重试次数",
                    "description": "节点执行失败时的重试次数",
                    "minimum": 0,
                    "maximum": 10,
                    "default": 3,
                    "examples": [
                        0,
                        3,
                        5
                    ]
                },
                "logLevel": {
                    "type": "string",
                    "title": "日志级别",
                    "description": "工作流执行时的日志级别",
                    "enum": [
                        "TRACE",
                        "DEBUG",
                        "INFO",
                        "WARN",
                        "ERROR"
                    ],
                    "default": "INFO",
                    "examples": [
                        "DEBUG",
                        "INFO",
                        "WARN"
                    ]
                },
                "enableMetrics": {
                    "type": "boolean",
                    "title": "启用指标收集",
                    "description": "是否收集执行指标",
                    "default": false
                },
                "parallelExecution": {
                    "type": "boolean",
                    "title": "并行执行",
                    "description": "是否启用节点并行执行",
                    "default": true
                },
                "maxConcurrentNodes": {
                    "type": "integer",
                    "title": "最大并发节点数",
                    "description": "同时执行的最大节点数量",
                    "minimum": 1,
                    "maximum": 20,
                    "default": 4
                }
            },
            "additionalProperties": true
        },
        "nodes": {
            "type": "array",
            "title": "节点列表",
            "description": "工作流中的所有节点定义",
            "minItems": 1,
            "items": {
                "$ref": "#/definitions/node"
            }
        },
        "connections": {
            "type": "array",
            "title": "连接关系",
            "description": "定义节点之间的连接关系",
            "items": {
                "$ref": "#/definitions/connection"
            }
        }
    },
    "additionalProperties": false,
    "definitions": {
        "node": {
            "type": "object",
            "title": "工作流节点",
            "description": "工作流中的单个节点定义",
            "required": [
                "id",
                "name",
                "type"
            ],
            "properties": {
                "id": {
                    "type": "string",
                    "title": "节点ID",
                    "description": "节点的唯一标识符",
                    "pattern": "^[a-zA-Z][a-zA-Z0-9_-]*$",
                    "examples": [
                        "data_source",
                        "error_detector",
                        "output_console"
                    ]
                },
                "name": {
                    "type": "string",
                    "title": "节点名称",
                    "description": "节点的显示名称",
                    "minLength": 1,
                    "examples": [
                        "数据源",
                        "错误检测器",
                        "控制台输出"
                    ]
                },
                "type": {
                    "type": "string",
                    "title": "节点类型",
                    "description": "节点的类型，决定节点的行为",
                    "enum": [
                        "input",
                        "output",
                        "datasource",
                        "diagnosis",
                        "script"
                    ],
                    "examples": [
                        "datasource",
                        "diagnosis",
                        "output"
                    ]
                },
                "enabled": {
                    "type": "boolean",
                    "title": "是否启用",
                    "description": "是否启用此节点",
                    "default": true
                },
                "position": {
                    "type": "object",
                    "title": "节点位置",
                    "description": "节点在可视化编辑器中的位置（可选）",
                    "properties": {
                        "x": {
                            "type": "integer",
                            "title": "X坐标",
                            "examples": [
                                100,
                                300,
                                500
                            ]
                        },
                        "y": {
                            "type": "integer",
                            "title": "Y坐标",
                            "examples": [
                                100,
                                200,
                                300
                            ]
                        }
                    },
                    "additionalProperties": false
                },
                "config": {
                    "type": "object",
                    "title": "节点配置",
                    "description": "节点特定的配置选项"
                }
            },
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "input"
                            }
                        }
                    },
                    "then": {
                        "properties": {
                            "config": {
                                "$ref": "#/definitions/inputNodeConfig"
                            }
                        }
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "output"
                            }
                        }
                    },
                    "then": {
                        "properties": {
                            "config": {
                                "$ref": "#/definitions/outputNodeConfig"
                            }
                        }
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "datasource"
                            }
                        }
                    },
                    "then": {
                        "properties": {
                            "config": {
                                "$ref": "#/definitions/datasourceNodeConfig"
                            }
                        }
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "diagnosis"
                            }
                        }
                    },
                    "then": {
                        "properties": {
                            "config": {
                                "$ref": "#/definitions/diagnosisNodeConfig"
                            }
                        }
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "script"
                            }
                        }
                    },
                    "then": {
                        "properties": {
                            "config": {
                                "$ref": "#/definitions/scriptNodeConfig"
                            }
                        }
                    }
                }
            ],
            "additionalProperties": false
        },
        "connection": {
            "type": "object",
            "title": "节点连接",
            "description": "定义两个节点之间的连接关系",
            "required": [
                "from",
                "to"
            ],
            "properties": {
                "from": {
                    "type": "string",
                    "title": "源节点ID",
                    "description": "连接的源节点ID",
                    "examples": [
                        "data_source",
                        "processor",
                        "analyzer"
                    ]
                },
                "to": {
                    "type": "string",
                    "title": "目标节点ID",
                    "description": "连接的目标节点ID",
                    "examples": [
                        "processor",
                        "analyzer",
                        "output"
                    ]
                },
                "enabled": {
                    "type": "boolean",
                    "title": "是否启用",
                    "description": "是否启用此连接",
                    "default": true
                },
                "condition": {
                    "type": "string",
                    "title": "连接条件",
                    "description": "连接的条件表达式（可选）",
                    "examples": [
                        "result.success == true",
                        "data.length > 0"
                    ]
                }
            },
            "additionalProperties": false
        },
        "inputNodeConfig": {
            "type": "object",
            "title": "输入节点配置",
            "description": "输入节点的配置选项",
            "properties": {
                "inputKey": {
                    "type": "string",
                    "title": "输入键",
                    "description": "从上下文中获取数据的键名",
                    "default": "input",
                    "examples": [
                        "user_input",
                        "config_data",
                        "parameters"
                    ]
                },
                "outputKey": {
                    "type": "string",
                    "title": "输出键",
                    "description": "将数据存储到上下文的键名",
                    "default": "output",
                    "examples": [
                        "processed_input",
                        "config",
                        "validated_data"
                    ]
                },
                "dataType": {
                    "type": "string",
                    "title": "数据类型",
                    "description": "输入数据的类型",
                    "enum": [
                        "string",
                        "integer",
                        "int",
                        "long",
                        "double",
                        "boolean",
                        "object"
                    ],
                    "default": "string",
                    "examples": [
                        "string",
                        "integer",
                        "boolean"
                    ]
                },
                "defaultValue": {
                    "title": "默认值",
                    "description": "当输入为空时使用的默认值",
                    "examples": [
                        "",
                        0,
                        false,
                        {}
                    ]
                }
            },
            "additionalProperties": true
        },
        "outputNodeConfig": {
            "type": "object",
            "title": "输出节点配置",
            "description": "输出节点的配置选项",
            "required": [
                "outputType"
            ],
            "properties": {
                "inputKey": {
                    "type": "string",
                    "title": "输入键",
                    "description": "从上下文中获取要输出数据的键名",
                    "default": "input",
                    "examples": [
                        "result",
                        "report",
                        "analysis_data"
                    ]
                },
                "outputType": {
                    "type": "string",
                    "title": "输出类型",
                    "description": "数据输出的目标类型",
                    "enum": [
                        "console",
                        "file",
                        "json",
                        "context"
                    ],
                    "examples": [
                        "console",
                        "file",
                        "json"
                    ]
                },
                "format": {
                    "type": "string",
                    "title": "输出格式",
                    "description": "输出数据的格式",
                    "enum": [
                        "text",
                        "json",
                        "xml",
                        "csv"
                    ],
                    "default": "text",
                    "examples": [
                        "json",
                        "text",
                        "csv"
                    ]
                },
                "filePath": {
                    "type": "string",
                    "title": "文件路径",
                    "description": "文件输出时的目标路径（outputType为file或json时使用）",
                    "examples": [
                        "output/result.txt",
                        "reports/analysis.json",
                        "logs/workflow.log"
                    ]
                },
                "append": {
                    "type": "boolean",
                    "title": "追加模式",
                    "description": "是否以追加模式写入文件",
                    "default": true
                },
                "contextKey": {
                    "type": "string",
                    "title": "上下文键",
                    "description": "输出到上下文时使用的键名（outputType为context时使用）",
                    "examples": [
                        "final_result",
                        "processed_data",
                        "summary"
                    ]
                }
            },
            "additionalProperties": true
        },
        "datasourceNodeConfig": {
            "type": "object",
            "title": "数据源节点配置",
            "description": "数据源节点的配置选项",
            "required": [
                "sourceType"
            ],
            "properties": {
                "sourceType": {
                    "type": "string",
                    "title": "数据源类型",
                    "description": "数据来源的类型",
                    "enum": [
                        "file",
                        "url",
                        "database",
                        "log",
                        "mock"
                    ],
                    "examples": [
                        "file",
                        "mock",
                        "log"
                    ]
                },
                "outputKey": {
                    "type": "string",
                    "title": "输出键",
                    "description": "将读取的数据存储到上下文的键名",
                    "default": "data",
                    "examples": [
                        "log_data",
                        "input_data",
                        "source_data"
                    ]
                },
                "filePath": {
                    "type": "string",
                    "title": "文件路径",
                    "description": "文件数据源的路径（sourceType为file时使用）",
                    "examples": [
                        "/var/log/app.log",
                        "data/input.txt",
                        "logs/system.log"
                    ]
                },
                "url": {
                    "type": "string",
                    "title": "URL地址",
                    "description": "URL数据源的地址（sourceType为url时使用）",
                    "format": "uri",
                    "examples": [
                        "http://api.example.com/data",
                        "https://logs.server.com/feed"
                    ]
                },
                "format": {
                    "type": "string",
                    "title": "数据格式",
                    "description": "数据的格式类型",
                    "enum": [
                        "text",
                        "json",
                        "lines",
                        "csv",
                        "xml"
                    ],
                    "default": "text",
                    "examples": [
                        "json",
                        "lines",
                        "text"
                    ]
                },
                "encoding": {
                    "type": "string",
                    "title": "字符编码",
                    "description": "文件的字符编码",
                    "default": "UTF-8",
                    "examples": [
                        "UTF-8",
                        "GBK",
                        "ISO-8859-1"
                    ]
                },
                "logPath": {
                    "type": "string",
                    "title": "日志文件路径",
                    "description": "日志数据源的文件路径（sourceType为log时使用）",
                    "examples": [
                        "/var/log/application.log",
                        "logs/error.log"
                    ]
                },
                "pattern": {
                    "type": "string",
                    "title": "匹配模式",
                    "description": "日志行的匹配模式或过滤条件",
                    "examples": [
                        "ERROR",
                        "\\d{4}-\\d{2}-\\d{2}",
                        "Exception"
                    ]
                },
                "maxLines": {
                    "type": "integer",
                    "title": "最大行数",
                    "description": "读取的最大行数",
                    "minimum": 1,
                    "maximum": 1000000,
                    "default": 1000,
                    "examples": [
                        100,
                        1000,
                        10000
                    ]
                },
                "mockType": {
                    "type": "string",
                    "title": "模拟数据类型",
                    "description": "模拟数据的类型（sourceType为mock时使用）",
                    "enum": [
                        "simple",
                        "error_logs",
                        "performance_logs",
                        "mixed_logs"
                    ],
                    "examples": [
                        "error_logs",
                        "simple",
                        "mixed_logs"
                    ]
                },
                "count": {
                    "type": "integer",
                    "title": "数据条数",
                    "description": "生成的模拟数据条数",
                    "minimum": 1,
                    "maximum": 10000,
                    "default": 10,
                    "examples": [
                        10,
                        100,
                        1000
                    ]
                }
            },
            "additionalProperties": true
        },
        "diagnosisNodeConfig": {
            "type": "object",
            "title": "诊断节点配置",
            "description": "诊断节点的配置选项",
            "required": [
                "diagnosisType"
            ],
            "properties": {
                "diagnosisType": {
                    "type": "string",
                    "title": "诊断类型",
                    "description": "执行的诊断分析类型",
                    "enum": [
                        "error_detection",
                        "pattern_analysis",
                        "performance_analysis",
                        "anomaly_detection",
                        "trend_analysis"
                    ],
                    "examples": [
                        "error_detection",
                        "performance_analysis",
                        "pattern_analysis"
                    ]
                },
                "inputKey": {
                    "type": "string",
                    "title": "输入键",
                    "description": "从上下文中获取要分析数据的键名",
                    "default": "data",
                    "examples": [
                        "log_data",
                        "input_data",
                        "filtered_logs"
                    ]
                },
                "outputKey": {
                    "type": "string",
                    "title": "输出键",
                    "description": "将诊断结果存储到上下文的键名",
                    "default": "diagnosis_result",
                    "examples": [
                        "error_results",
                        "analysis_result",
                        "diagnosis_output"
                    ]
                },
                "errorPatterns": {
                    "type": "array",
                    "title": "错误模式",
                    "description": "用于错误检测的模式列表（diagnosisType为error_detection时使用）",
                    "items": {
                        "type": "string"
                    },
                    "default": [
                        "ERROR",
                        "FATAL",
                        "Exception",
                        "Failed"
                    ],
                    "examples": [
                        [
                            "ERROR",
                            "FATAL"
                        ],
                        [
                            "Exception",
                            "Timeout",
                            "Failed"
                        ]
                    ]
                },
                "slowThreshold": {
                    "type": "number",
                    "title": "慢响应阈值",
                    "description": "性能分析中判定慢响应的阈值（毫秒）（diagnosisType为performance_analysis时使用）",
                    "minimum": 0,
                    "default": 1000.0,
                    "examples": [
                        500.0,
                        1000.0,
                        2000.0
                    ]
                },
                "realTimeMode": {
                    "type": "boolean",
                    "title": "实时模式",
                    "description": "是否启用实时诊断模式",
                    "default": false
                }
            },
            "additionalProperties": true
        },
        "scriptNodeConfig": {
            "type": "object",
            "title": "脚本节点配置",
            "description": "脚本节点的配置选项",
            "required": [
                "script"
            ],
            "properties": {
                "scriptEngine": {
                    "type": "string",
                    "title": "脚本引擎",
                    "description": "执行脚本的引擎类型",
                    "enum": [
                        "javascript",
                        "js",
                        "groovy",
                        "python"
                    ],
                    "default": "javascript",
                    "examples": [
                        "javascript",
                        "groovy"
                    ]
                },
                "inputKey": {
                    "type": "string",
                    "title": "输入键",
                    "description": "从上下文中获取输入数据的键名",
                    "default": "input",
                    "examples": [
                        "data",
                        "input_data",
                        "source"
                    ]
                },
                "outputKey": {
                    "type": "string",
                    "title": "输出键",
                    "description": "将脚本结果存储到上下文的键名",
                    "default": "output",
                    "examples": [
                        "result",
                        "processed_data",
                        "script_output"
                    ]
                },
                "script": {
                    "type": "string",
                    "title": "脚本内容",
                    "description": "要执行的脚本代码",
                    "examples": [
                        "var result = input.map(x => x * 2); result;",
                        "logger.info('Processing data...'); input.filter(x => x.level !== 'DEBUG');"
                    ]
                },
                "parameters": {
                    "type": "object",
                    "title": "脚本参数",
                    "description": "传递给脚本的参数对象",
                    "additionalProperties": true,
                    "examples": [
                        {
                            "threshold": 100,
                            "mode": "strict"
                        },
                        {
                            "pattern": "ERROR",
                            "maxItems": 50
                        }
                    ]
                }
            },
            "additionalProperties": true
        }
    }
}